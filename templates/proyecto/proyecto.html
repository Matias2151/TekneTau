{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesti√≥n de Proyectos - TEKNETAU</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="{% static 'style.css' %}">

<style>
/* ====== GENERAL ====== */
textarea, select, input {
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px;
  font-family: inherit;
}
textarea { min-height: 100px; resize: vertical; }
.form-inline { display: flex; gap: 15px; }
.form-inline .form-group { flex: 1; }

/* ====== TABLA ====== */
.tabla-proyectos { width: 100%; border-collapse: collapse; }
.tabla-proyectos th, .tabla-proyectos td {
  padding: 10px 12px;
  border-bottom: 1px solid #ddd;
  vertical-align: middle;
}
.tabla-proyectos tr:hover { background-color: #f8f9fa; }
.tabla-proyectos th {
  background-color: #f4f4f4;
  font-weight: 600;
  color: #333;
}
.tabla-proyectos th:last-child { text-align: center; } /* Acciones centrado */

/* Evitar doble borde bajo botones dentro del td */
.action-buttons, .action-buttons * { border-bottom: none !important; }

/* ====== ACCIONES ====== */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

/* ====== ESTADOS ====== */
.estado-badge {
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  color: #fff;
  display: inline-block;
  min-width: 110px;
  text-align: center;
}
.estado-pendiente { background-color: #f39c12; }
.estado-en-progreso { background-color: #3498db; }
.estado-terminado { background-color: #2ecc71; }
.estado-cancelado { background-color: #e74c3c; }

/* ====== MODALES ====== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}
.modal.show { display: flex; }
.modal-content {
  background: white;
  border-radius: 10px;
  padding: 20px;
  width: 90%;
  max-width: 700px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  animation: fadeIn 0.25s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ====== MODAL VER ====== */
#modalVerProyecto .modal-content { max-width: 600px; }
#modalVerProyecto .detalle {
  margin-bottom: 10px;
  border-bottom: 1px solid #eee;
  padding-bottom: 6px;
}
#modalVerProyecto strong { color: #2c3e50; }

/* ====== CONFIRMAR ELIMINAR ====== */
#confirmDeleteModal .modal-content {
  max-width: 400px;
  text-align: center;
}
#confirmDeleteModal h3 { margin: 0; color: #2c3e50; }
#confirmDeleteModal .btn-danger { background-color: #e74c3c; border: none; }
#confirmDeleteModal .btn-danger:hover { background-color: #c0392b; }
#confirmDeleteModal .btn-secondary { background-color: #7f8c8d; border: none; }
#confirmDeleteModal .btn-secondary:hover { background-color: #707b7c; }

/* ====== ERRORES DE CAMPOS ====== */
.error-container {
  color: #e74c3c;
  font-size: 0.9em;
  margin-top: 3px;
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <img src="{% static 'logo.png' %}" alt="Logo TEKNETAU" class="sidebar-logo">
  </div>
  <ul class="sidebar-nav">
    {% if request.session.user_role == 'contador' %}
      <li><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Panel de Control</a></li>
      <li class="active"><a href="{% url 'proyectoapp:lista_proyectos' %}"><i class="fas fa-briefcase"></i> Proyectos</a></li>
      <li><a href="{% url 'facturacionapp:lista_documentos' %}"><i class="fas fa-file-invoice-dollar"></i> Facturaci√≥n</a></li>
    {% else %}
      <li><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i> Panel de Control</a></li>
      <li><a href="{% url 'empresa_clientes' %}"><i class="fas fa-users"></i> Empresa / Persona</a></li>
      <li><a href="{% url 'productoyservicioapp:lista_productos' %}"><i class="fas fa-box-open"></i> Productos / Servicios</a></li>
      <li class="active"><a href="{% url 'proyectoapp:lista_proyectos' %}"><i class="fas fa-briefcase"></i> Proyectos</a></li>
      <li><a href="{% url 'facturacionapp:lista_documentos' %}"><i class="fas fa-file-invoice-dollar"></i> Documentos</a></li>
      <li><a href="{% url 'usuariosapp:usuarios_admin' %}"><i class="fas fa-user-shield"></i> Usuarios</a></li>
    {% endif %}
  </ul>
</aside>

<!-- MAIN -->
<main class="main-content">

  <!-- HEADER (modificado para mostrar usuario, rol y logout) -->
  <header class="top-header">
    <h1>Gesti√≥n de Proyectos</h1>
    <div class="user-info">
      <span>
        {{ request.session.username|default:"Invitado" }}
        {% if request.session.user_role %}
          ({{ request.session.user_role }})
        {% endif %}
      </span>
      <a href="{% url 'usuariosapp:logout' %}" class="btn btn-sm btn-outline">
        Cerrar sesi√≥n
      </a>
    </div>
  </header>

  {% if messages %}
  <div id="messages">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}


  <!-- Tarjetas -->
  <div class="stats-grid">

    <div class="stat-card info">
      <div class="stat-content">
        <h3>Total Utilidad</h3>
        <div class="stat-number" id="card-utilidad">${{ utilidad_total|floatformat:0|intcomma }}</div>
      </div>
      <i class="fas fa-file-invoice stat-icon"></i>
    </div>

    <div class="stat-card success">
      <div class="stat-content">
        <h3>Total Gastos</h3>
        <div class="stat-number" id="card-egresos">${{ egresos_total|floatformat:0|intcomma }}</div>
      </div>
      <i class="fas fa-dollar-sign stat-icon"></i>
    </div>

  </div>


  <!-- Contenido principal -->  
  <div class="content-card">
    <h3><i class="fas fa-list"></i> Proyectos Registrados</h3>

    <div class="action-bar">
        <button type="button" class="btn btn-primary" id="btnNuevoProyecto">
            <i class="fas fa-plus-circle"></i> A√±adir Nuevo
        </button>
        <div class="search-box">
            <input type="search" id="searchInput" placeholder="Buscar por nombre...">
            <button><i class="fas fa-search"></i></button>
        </div>
    </div>

    <!-- üîé FILTRO DE FECHAS -->
    <div class="filter-bar" style="margin-top: 15px; display:flex; gap:15px; align-items:center;">

        <!-- Tipo de fecha -->
        <div>
            <label style="font-weight:600;">Filtrar por:</label>
            <select id="filterType" class="form-control" style="width:180px;">
                <option value="sol">Fecha Solicitud</option>
                <option value="ter">Fecha T√©rmino</option>
            </select>
        </div>

        <!-- Fecha desde -->
        <div>
            <label style="font-weight:600;">Desde:</label>
            <input type="date" id="filterFrom" class="form-control" style="width:170px;">
        </div>

        <!-- Fecha hasta -->
        <div>
            <label style="font-weight:600;">Hasta:</label>
            <input type="date" id="filterTo" class="form-control" style="width:170px;">
        </div>

        <!-- Botones -->
        <button id="btnFiltrarFecha" class="btn btn-secondary" style="height:34px; margin-top:2px;">
            <i class="fas fa-filter"></i> Filtrar
        </button>

        <button id="btnLimpiarFiltro" class="btn btn-primary"
                style="height:34px; margin-top:2px; border:1px solid #ccc;">
            Limpiar
        </button>

    </div>
    

    <table class="tabla-proyectos" id="tablaProyectos" style="margin-top:10px;">
      <thead>
        <tr>
          <th>IDP</th>
          <th>Nombre</th>
          <th>Fecha Entrega</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in proyectos %}
        <tr
          data-id="{{ p.proye_idt }}"
          data-desc="{{ p.proye_desc }}"
          data-idp="{{ p.proye_idp }}"
          data-obs="{{ p.proye_obs }}"
          data-cost="{{ p.proye_cost }}"
          data-fecha-sol="{{ p.proye_fecha_sol|date:'Y-m-d' }}"
          data-fecha-ter="{{ p.proye_fecha_ter|date:'Y-m-d' }}"
          data-estado="{{ p.proye_estado }}"
          data-cliente-id="{{ p.cliente.emppe_id|default:'' }}"
          data-cliente="{{ p.cliente.emppe_nom|default:'Sin asignar' }}"
          data-cliente-rut="{{ p.cliente.emppe_rut|default:'‚Äî' }}"
          data-cliente-mail="{{ p.cliente.emppe_mail1|default:'‚Äî' }}"
          data-cliente-fono="{{ p.cliente.emppe_fono1|default:'‚Äî' }}"
          data-utilidad="{{ p.utilidad_calc }}"
          data-egresos="{{ p.egresos_calc }}"
        >
          <td>{{ p.proye_idp }}</td>
          <td class="desc">{{ p.proye_desc }}</td>
          <td class="fecha_ter">{{ p.proye_fecha_ter|date:"d/m/Y" }}</td>
          <td>
            <span class="estado estado-badge estado-{{ p.proye_estado|slugify }}">{{ p.proye_estado }}</span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-view" title="Ver" onclick="verProyecto(this)">
                <i class="fas fa-eye"></i>
              </button>

              <button class="btn-edit" title="Editar" onclick="editarProyecto(this)">
                <i class="fas fa-pencil-alt"></i>
              </button>

              <button 
                  type="button"
                  class="btn btn-warning btn-sm btnContabilidad"
                  data-id="{{ p.proye_idt }}"
                  onclick="verContabilidad(this)"
                  style="background-color:#006400; border:none;">
                  <i class="fas fa-dollar-sign"></i>
              </button>

              <form action="{% url 'proyectoapp:eliminar_proyecto' p.proye_idt %}"
                    method="post"
                    class="delete-form"
                    data-nombre="{{ p.proye_desc }}">
                {% csrf_token %}
                <button class="btn-delete" type="submit" title="Eliminar">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5">No hay proyectos registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<!-- MODAL AGREGAR/EDITAR -->
<div id="modalProyecto" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle"><i class="fas fa-folder-plus"></i> Proyecto</h3>
      <button class="close-modal" onclick="cerrarModalCRUD()">&times;</button>
    </div>

    <form id="formProyecto" method="POST" action="">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group">
          <label for="cliente"><i class="fas fa-user"></i> Cliente</label>
          <select id="cliente" name="cliente" class="form-select">
            <option value="">-- Selecciona cliente --</option>
            {% for c in clientes %}
              <option value="{{ c.emppe_id }}">{{ c.emppe_nom }}</option>
            {% endfor %}
          </select>
          <div id="error-cliente" class="error-container"></div>
        </div>

        <div class="form-group">
          <label for="id_proye_idp"><i class="fas fa-hashtag"></i> ID Proyecto</label>
          {{ form.proye_idp }}
          <div id="error-proye_idp" class="error-container"></div>
        </div>

        <div class="form-group">
          <label for="id_proye_desc"><i class="fas fa-file-signature"></i> Descripci√≥n</label>
          {{ form.proye_desc }}
          <div id="error-proye_desc" class="error-container"></div>
        </div>

        <div class="form-group">
          <label for="id_proye_obs"><i class="fas fa-comment"></i> Observaciones</label>
          {{ form.proye_obs }}
          <div id="error-proye_obs" class="error-container"></div>
        </div>

        <div class="form-group">
          <label for="id_proye_cost"><i class="fas fa-dollar-sign"></i> Costo del Proyecto</label>
          {{ form.proye_cost }}
          <div id="error-proye_cost" class="error-container"></div>
        </div>

        <div class="form-inline">
          <div class="form-group">
            <label for="id_proye_fecha_sol"><i class="fas fa-calendar-plus"></i> Fecha Solicitud</label>
            {{ form.proye_fecha_sol }}
            <div id="error-proye_fecha_sol" class="error-container"></div>
          </div>
          <div class="form-group">
            <label for="id_proye_fecha_ter"><i class="fas fa-calendar-check"></i> Fecha T√©rmino</label>
            {{ form.proye_fecha_ter }}
            <div id="error-proye_fecha_ter" class="error-container"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="id_proye_estado"><i class="fas fa-tasks"></i> Estado</label>
          {{ form.proye_estado }}
          <div id="error-proye_estado" class="error-container"></div>
        </div>
      </div>

      <div class="form-actions" style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button>
        <button type="button" class="btn btn-secondary" onclick="cerrarModalCRUD()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL VER -->
<div id="modalVerProyecto" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-eye"></i> Detalles del Proyecto</h3>
      <button class="close-modal" onclick="cerrarModalVer()">&times;</button>
    </div>
    <div class="modal-body" id="detalleProyecto"></div>
  </div>
</div>

<!-- ================================================================= -->
<!-- MODAL CONTABILIDAD DEL PROYECTO (SIN BOOTSTRAP) -->
<!-- ================================================================= -->
<div id="modalContabilidad" class="modal">
  <div class="modal-content" style="max-width:900px; width:95%;">

    <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">
        <i class="fas fa-dollar-sign"></i> Informaci√≥n Contable del Proyecto
      </h3>
      <button class="close-modal" onclick="cerrarModalContable()">&times;</button>
    </div>

    <div class="modal-body">

      <!-- ======================= -->
      <!-- INFO DEL PROYECTO -->
      <!-- ======================= -->
      <div id="contaProyectoHeader"
           style="margin-bottom:12px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#f9f9f9;">
          <h4 style="margin:0 0 4px 0;">Proyecto: <span id="contaProyNombre"></span></h4>
          <p style="margin:0;">
              <strong>Cliente:</strong> <span id="contaProyCliente"></span>
          </p>

          <p style="margin:4px 0 0 0;">
              <strong>Costo del proyecto:</strong> $<span id="contaProyCosto"></span>
          </p>

          <p style="margin:2px 0 0 0;">
              <strong>Utilidad actual:</strong> $<span id="contaProyUtilidad" style="color:green; font-weight:bold;"></span>
          </p>
      </div>


      <!-- ======================= -->
      <!-- BARRA DE COSTO Y EGRESOS -->
      <!-- ======================= -->
      <div style="margin-bottom:15px;">
          <p style="margin:0; font-weight:bold;">Ejecuci√≥n del Proyecto:</p>

          <div style="
              width:100%;
              background:#ddd;
              height:22px;
              border-radius:10px;
              overflow:hidden;
              margin-top:6px;">
              
              <!-- Barra verde (costo total) -->
              <div id="barraCosto"
                  style="height:22px; width:100%; background:#2ecc71;"></div>

              <!-- Barra roja (egresos reales) ‚Äî se superpone -->
              <div id="barraEgresos"
                  style="
                      height:22px;
                      width:0%;
                      background:#e74c3c;
                      position:relative;
                      top:-22px;">
              </div>
          </div>

          <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:13px;">
              <span>Gastos del proyecto: $<span id="contaTotalEgresos">0</span></span>
              <span>Ingresos del proyecto: $<span id="contaTotalIngresos">0</span></span>
          </div>
      </div>


      <!-- ======================= -->
      <!-- TABLA DE DOCUMENTOS -->
      <!-- ======================= -->
      <table class="tabla-proyectos" style="margin-top:10px;">
          <thead>
              <tr>
                  <th>N√∫mero</th>
                  <th>Fecha</th>
                  <th>Estado</th>
                  <th>Total</th>
                  <th>Ver detalles</th>
              </tr>
          </thead>
          <tbody id="contaDocsBody"></tbody>
      </table>

    </div>

    <div class="modal-footer" style="text-align:right; padding:10px 0;">
      <button class="btn btn-secondary" onclick="cerrarModalContable()">Cerrar</button>
    </div>

  </div>
</div>



<!-- ================================================================= -->
<!-- MODAL DETALLE DOCUMENTO (SIN BOOTSTRAP) -->
<!-- ================================================================= -->
<div id="modalDetalleDocumento" class="modal">
  <div class="modal-content" style="max-width:800px; width:95%;">

    <div class="modal-header" style="background:#5dade2; color:white; display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">
        <i class="fas fa-file-invoice"></i> Detalle del Documento
      </h3>
      <button class="close-modal" onclick="cerrarModalDetalle()">&times;</button>
    </div>

    <div class="modal-body">
      <table class="tabla-proyectos">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cant</th>
            <th>Precio</th>
            <th>Total</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="detalleDocumentoBody"></tbody>
      </table>
    </div>

    <div class="modal-footer" style="text-align:right; padding:10px 0;">
      <button class="btn btn-secondary" onclick="cerrarModalDetalle()">Cerrar</button>
    </div>

  </div>
</div>


<!-- CONFIRMAR ELIMINAR -->
<div id="confirmDeleteModal" class="modal">
  <div class="modal-content">
    <h3><i class="fas fa-exclamation-triangle" style="color:#e74c3c;"></i> Confirmar eliminaci√≥n</h3>
    <p id="deleteMessage">¬øDeseas eliminar este registro?</p>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:16px;">
      <button class="btn btn-danger" id="btnConfirmDelete"><i class="fas fa-trash"></i> Eliminar</button>
      <button class="btn btn-secondary" id="btnCancelDelete">Cancelar</button>
    </div>
  </div>
</div>

<div id="confirmQuitarModal" class="modal">
  <div class="modal-content" style="max-width:400px;text-align:center;">
    <h3><i class="fas fa-exclamation-triangle" style="color:#e74c3c;"></i> Quitar documento</h3>

    <p id="quitarMessage" style="margin:10px 0; font-size:1rem;">
      ¬øDeseas quitar este documento del proyecto?  
    </p>

    <div style="margin-top:18px;display:flex;justify-content:center;gap:10px;">
      <button id="btnCancelQuitar" class="btn btn-secondary">Cancelar</button>
      <button id="btnConfirmQuitar" class="btn btn-danger" style="background-color:#e74c3c; color:#fff;">Quitar</button>
    </div>
  </div>
</div>

<script>
/* ====== Refs ====== */
const modalCRUD     = document.getElementById('modalProyecto');
const modalVer      = document.getElementById('modalVerProyecto');
const form          = document.getElementById('formProyecto');
const confirmModal  = document.getElementById('confirmDeleteModal');
const deleteMessage = document.getElementById('deleteMessage');
let formToDelete    = null;

/* ====== Helper: construir URL segura ====== */
const editarBase = "{% url 'proyectoapp:editar_proyecto' 0 %}".replace("0/", "");

/* ====== Obtener token CSRF ====== */
function getCSRFToken() {
  const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
  return tokenInput ? tokenInput.value : '';
}

// ===============================
// FUNCI√ìN PARA OBTENER CSRF TOKEN
// ===============================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// /* Helper: formatear fecha YYYY-MM-DD -> dd/mm/aaaa */
function formatDateDisplay(isoDate) {
  if (!isoDate) return '‚Äî';
  const parts = isoDate.split('-');
  if (parts.length !== 3) return isoDate;
  const [year, month, day] = parts;
  return `${day}/${month}/${year}`;
}

/* ====== Mostrar errores ====== */
function mostrarErrores(errors) {
  document.querySelectorAll('.error-container').forEach(div => div.textContent = "");
  form.querySelectorAll('.form-error').forEach(e => e.remove());

  for (const [campo, mensajes] of Object.entries(errors)) {
    if (campo === "__all__") continue;
    const errorDiv = document.getElementById(`error-${campo}`);
    if (errorDiv) errorDiv.textContent = mensajes.join(', ');
  }

  if (errors.__all__) {
    const general = document.createElement('div');
    general.className = 'form-error';
    general.style.color = '#e74c3c';
    general.style.margin = '8px 0';
    general.textContent = errors.__all__.join(', ');
    form.prepend(general);
  }
}

/* ===========================================
   üîπ Abrir modal: NUEVO 
=========================================== */
const btnNuevo = document.getElementById('btnNuevoProyecto');
if (btnNuevo) {
  btnNuevo.addEventListener('click', () => {
    form.action = "{% url 'proyectoapp:crear_proyecto' %}";
    form.dataset.mode = "crear";
    form.reset();

    document.getElementById('modalTitle').innerHTML =
      '<i class="fas fa-folder-plus"></i> Nuevo Proyecto';

    document.querySelectorAll('.error-container').forEach(div => div.textContent = "");

    modalCRUD.classList.add('show');
  });
}

/* ===========================================
   üîπ Editar proyecto
=========================================== */
function editarProyecto(btn) {
  const tr = btn.closest('tr');
  const id = tr.dataset.id;

  form.action = `${editarBase}${id}/`;
  form.dataset.mode = "editar";
  form.reset();

  document.querySelectorAll('.error-container').forEach(div => div.textContent = "");

  // Cargar campos
  document.getElementById('id_proye_idp').value        = tr.dataset.idp || '';
  document.getElementById('id_proye_desc').value       = tr.dataset.desc || '';
  document.getElementById('id_proye_obs').value        = tr.dataset.obs || '';
  document.getElementById('id_proye_cost').value       = tr.dataset.cost || '';
  document.getElementById('id_proye_fecha_sol').value  = tr.dataset.fechaSol || '';
  document.getElementById('id_proye_fecha_ter').value  = tr.dataset.fechaTer || '';
  document.getElementById('id_proye_estado').value     = tr.dataset.estado || '';

  const selectCliente = document.getElementById('cliente');
  if (selectCliente) selectCliente.value = tr.dataset.clienteId || '';

  modalCRUD.classList.add('show');
}

/* ===========================================
   üîπ Enviar formulario (AJAX)
=========================================== */
form.addEventListener('submit', function (e) {
  e.preventDefault();

  document.querySelectorAll('.error-container').forEach(div => div.textContent = "");

  const idp      = document.getElementById('id_proye_idp').value.trim();
  const desc     = document.getElementById('id_proye_desc').value.trim();
  const fechaSol = document.getElementById('id_proye_fecha_sol').value;
  const fechaTer = document.getElementById('id_proye_fecha_ter').value;
  const estado   = document.getElementById('id_proye_estado').value;
  const cliente  = document.getElementById('cliente').value;

  const errores = {};

  if (!idp) errores.proye_idp = ["Debes ingresar un ID p√∫blico."];
  else if (!/^[A-Za-z0-9\-_]+$/.test(idp))
    errores.proye_idp = ["Formato inv√°lido para el ID p√∫blico."];

  if (!desc) errores.proye_desc = ["La descripci√≥n es obligatoria."];

  if (!cliente) errores.cliente = ["Debes seleccionar un cliente."];

  if (!fechaSol) errores.proye_fecha_sol = ["La fecha de solicitud es obligatoria."];
  if (fechaTer && new Date(fechaTer) < new Date(fechaSol))
    errores.proye_fecha_ter = ["La fecha de t√©rmino no puede ser anterior a la de solicitud."];

  if (!estado) errores.proye_estado = ["Debes seleccionar un estado."];

  if (Object.keys(errores).length > 0) {
    mostrarErrores(errores);
    return;
  }

  const formData = new FormData(form);

  fetch(form.action, {
    method: "POST",
    headers: {
      "X-Requested-With": "XMLHttpRequest",
      "X-CSRFToken": getCSRFToken()
    },
    body: formData
  })
  .then(res => res.json())
  .then(data => {

    if (!data.success) {
      mostrarErrores(data.errors || {__all__: ["Error al guardar"]});
      return;
    }

    const tbody = document.querySelector('#tablaProyectos tbody');
    const info  = data.created || data.updated;

    if (data.created) {
      const fila = document.createElement('tr');
      const estadoSlug = info.estado.toLowerCase().replace(/\s+/g, '-');

      fila.dataset.id         = info.id;
      fila.dataset.idp        = info.idp;
      fila.dataset.desc       = info.desc;
      fila.dataset.obs        = info.obs;
      fila.dataset.cost       = info.cost;
      fila.dataset.fechaSol   = info.fecha_sol;
      fila.dataset.fechaTer   = info.fecha_ter;
      fila.dataset.estado     = info.estado;
      fila.dataset.clienteId  = info.cliente_id;
      fila.dataset.cliente    = info.cliente_nombre;

      fila.innerHTML = `
        <td>${info.idp}</td>
        <td class="desc">${info.desc}</td>
        <td class="fecha_ter">${formatDateDisplay(info.fecha_ter)}</td>
        <td><span class="estado-badge estado-${estadoSlug}">${info.estado}</span></td>
        <td>
          <div class="action-buttons">
            <button class="btn-view" onclick="verProyecto(this)"><i class="fas fa-eye"></i></button>
            <button class="btn-edit" onclick="editarProyecto(this)"><i class="fas fa-pencil-alt"></i></button>
            <form action="/proyectos/eliminar/${info.id}/" method="post" class="delete-form" data-nombre="${info.desc}">
              <input type="hidden" name="csrfmiddlewaretoken" value="${getCSRFToken()}">
              <button type="submit" class="btn-delete"><i class="fas fa-trash"></i></button>
            </form>
          </div>
        </td>`;
      tbody.prepend(fila);
    }

    if (data.updated) {
      const row = document.querySelector(`tr[data-id="${info.id}"]`);
      row.dataset.idp = info.idp;
      row.querySelector("td:first-child").textContent = info.idp;
      row.querySelector('.desc').textContent          = info.desc;
      row.querySelector('.fecha_ter').textContent     = formatDateDisplay(info.fecha_ter);
      row.querySelector('.estado-badge').textContent  = info.estado;
    }

    modalCRUD.classList.remove('show');
  })
});

/* ===========================================
   üîπ Ver proyecto
=========================================== */
function verProyecto(btn) {
  const tr = btn.closest("tr");
  const d  = document.getElementById("detalleProyecto");

  d.innerHTML = `
    <div class="detalle"><strong>ID P√∫blico:</strong> ${tr.dataset.idp}</div>
    <div class="detalle"><strong>Descripci√≥n:</strong> ${tr.dataset.desc}</div>
    <div class="detalle"><strong>Cliente:</strong> ${tr.dataset.cliente}</div>
    <div class="detalle"><strong>Fecha Solicitud:</strong> ${formatDateDisplay(tr.dataset.fechaSol)}</div>
    <div class="detalle"><strong>Fecha T√©rmino:</strong> ${formatDateDisplay(tr.dataset.fechaTer)}</div>
  `;

  modalVer.classList.add('show');
}

/* ===========================================
   üîπ Eliminar
=========================================== */
document.querySelectorAll('.delete-form').forEach(formEl => {
  formEl.addEventListener('submit', e => {
    e.preventDefault();
    formToDelete = formEl;
    deleteMessage.textContent = `¬øDeseas eliminar "${formEl.dataset.nombre}"?`;
    confirmModal.classList.add('show');
  });
});

document.getElementById('btnCancelDelete').addEventListener('click', () => {
  confirmModal.classList.remove('show');
});

document.getElementById('btnConfirmDelete').addEventListener('click', () => {
  if (formToDelete) formToDelete.submit();
  confirmModal.classList.remove('show');
});

/* ===========================================
   üîπ Cerrar modales
=========================================== */
function cerrarModalCRUD() { modalCRUD.classList.remove('show'); }
function cerrarModalVer()  { modalVer.classList.remove('show'); }

[modalCRUD, modalVer, confirmModal].forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); });
});

// ===============================================
// FILTRADO POR FECHA DE SOLICITUD o FECHA DE T√âRMINO
// ===============================================
document.getElementById("btnFiltrarFecha").addEventListener("click", () => {
    const desde = document.getElementById("filterFrom").value;
    const hasta = document.getElementById("filterTo").value;
    const tipo = document.getElementById("filterType").value; // sol o ter

    const filas = document.querySelectorAll("#tablaProyectos tbody tr");

    filas.forEach(row => {
        const fecha = tipo === "sol" ? row.dataset.fechaSol : row.dataset.fechaTer;

        if (!fecha) {
            row.style.display = "";
            return;
        }

        let mostrar = true;

        if (desde && fecha < desde) mostrar = false;
        if (hasta && fecha > hasta) mostrar = false;

        row.style.display = mostrar ? "" : "none";
    });
});

// LIMPIAR FILTRO
document.getElementById("btnLimpiarFiltro").addEventListener("click", () => {
    document.getElementById("filterFrom").value = "";
    document.getElementById("filterTo").value = "";

    document.querySelectorAll("#tablaProyectos tbody tr")
        .forEach(r => r.style.display = "");
});


// LIMPIAR FILTRO
document.getElementById("btnLimpiarFiltro").addEventListener("click", () => {
    document.getElementById("filterFrom").value = "";
    document.getElementById("filterTo").value = "";

    document.querySelectorAll("#tablaProyectos tbody tr")
        .forEach(r => r.style.display = "");
});

// =============================================================
// MODAL CONTABILIDAD ‚Äî JS CORREGIDO TOTALMENTE
// =============================================================

const modalContabilidad = document.getElementById("modalContabilidad");
const contaDocsBody = document.getElementById("contaDocsBody");
const contaProyNombre = document.getElementById("contaProyNombre");
const contaProyCliente = document.getElementById("contaProyCliente");

const contaProyCosto = document.getElementById("contaProyCosto");
const contaProyUtilidad = document.getElementById("contaProyUtilidad");
const contaTotalIngresos = document.getElementById("contaTotalIngresos");
const contaTotalEgresos = document.getElementById("contaTotalEgresos");

const barraCosto = document.getElementById("barraCosto");
const barraEgresos = document.getElementById("barraEgresos");

function cerrarModalContable() {
    modalContabilidad.classList.remove("show");
}


// ===================================================================
// ABRIR CONTABILIDAD DEL PROYECTO
// ===================================================================
function verContabilidad(btn) {

    const tr = btn.closest("tr");
    const proyectoId = tr.dataset.id;

    // Encabezado
    contaProyNombre.textContent = tr.dataset.desc || "(Sin nombre)";
    contaProyCliente.textContent = tr.dataset.cliente || "(Sin cliente)";

    // Reset visual
    contaDocsBody.innerHTML = `
        <tr><td colspan="5" style="text-align:center;">Cargando informaci√≥n...</td></tr>
    `;

    barraCosto.style.width = "100%";
    barraEgresos.style.width = "0%";

    // === URL CORRECTA SEG√öN TU urls.py ===
    fetch(`/proyectos/api/documentos/${proyectoId}/`)
        .then(res => res.json())
        .then(data => {

            // ===============================
            // MOSTRAR COSTO, INGRESOS, EGRESOS, UTILIDAD
            // ===============================

            contaProyCosto.textContent = data.proyecto.costo.toLocaleString();
            contaTotalIngresos.textContent = data.proyecto.ingresos.toLocaleString();
            contaTotalEgresos.textContent = data.proyecto.egresos.toLocaleString();
            contaProyUtilidad.textContent = data.proyecto.utilidad.toLocaleString();

            // ===============================
            // ACTUALIZAR BARRA DE PROGRESO
            // ===============================

            const porcentajeRestante = data.proyecto.porcentaje_restante;

            barraCosto.style.width = "100%";
            barraEgresos.style.width = (100 - porcentajeRestante) + "%";

            // ===============================
            // TABLA DE DOCUMENTOS
            // ===============================

            if (!data.docs.length) {
                contaDocsBody.innerHTML = `
                    <tr><td colspan="5" style="text-align:center;">
                        No existen documentos asociados a este proyecto.
                    </td></tr>
                `;
                modalContabilidad.classList.add("show");
                return;
            }

            let html = "";

            data.docs.forEach(doc => {
                html += `
                    <tr>
                        <td>${doc.num}</td>
                        <td>${doc.fecha}</td>
                        <td>${doc.estado}</td>
                        <td>$${doc.total.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="verDetalleDocumento(${doc.id})">
                                Ver
                            </button>
                            <button class="btn btn-danger"
                                onclick="abrirModalQuitar(${doc.id}, ${proyectoId}, ${doc.num})"
                                style="background-color:#e74c3c; border:none; margin-left:6px;">
                                Quitar
                            </button>
                        </td>
                    </tr>

                    <tr id="detalle-doc-${doc.id}" style="display:none;">
                        <td colspan="5"></td>
                    </tr>
                `;
            });

            contaDocsBody.innerHTML = html;

            modalContabilidad.classList.add("show");
        });
}


// ===================================================================
// VER DETALLE DOCUMENTO
// ===================================================================
function verDetalleDocumento(idDoc) {

    const fila = document.getElementById(`detalle-doc-${idDoc}`);
    const contenedor = fila.querySelector("td");

    if (fila.style.display === "table-row") {
        fila.style.display = "none";
        return;
    }

    fila.style.display = "table-row";
    contenedor.innerHTML = "Cargando...";

    fetch(`/facturacion/api/documento/${idDoc}/`)
        .then(res => res.json())
        .then(data => {

            let html = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant.</th>
                            <th>Precio</th>
                            <th>Total</th>
                            <th>Obs.</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.detalle.forEach(det => {
                html += `
                    <tr>
                        <td>${det.nombre}</td>
                        <td>${det.cant}</td>
                        <td>$${det.precio.toLocaleString()}</td>
                        <td>$${det.total.toLocaleString()}</td>
                        <td>${det.obs}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";

            contenedor.innerHTML = html;
        });
}

// =============================================================
// MODAL PERSONALIZADO PARA QUITAR DOCUMENTO DEL PROYECTO
// =============================================================
const modalQuitar = document.getElementById("confirmQuitarModal");
const quitarMessage = document.getElementById("quitarMessage");
const btnConfirmQuitar = document.getElementById("btnConfirmQuitar");
const btnCancelQuitar = document.getElementById("btnCancelQuitar");

let quitarDocId = null;
let quitarProyectoId = null;

function abrirModalQuitar(docId, proyectoId, docNum = null) {
    quitarDocId = docId;
    quitarProyectoId = proyectoId;

    quitarMessage.textContent = docNum
        ? `¬øDeseas quitar el documento N¬∫ ${docNum} de este proyecto?`
        : "¬øDeseas quitar este documento del proyecto?";

    modalQuitar.classList.add("show");
}

btnCancelQuitar.addEventListener("click", () => {
    modalQuitar.classList.remove("show");
});

// Confirmar acci√≥n
btnConfirmQuitar.addEventListener("click", () => {

    fetch(`/facturacion/api/documento/${quitarDocId}/quitar/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
        }
    })
    .then(r => r.json())
    .then(data => {
        modalQuitar.classList.remove("show");

        if (!data.success) {
            alert("Error al quitar el documento.");
            return;
        }

        // Recarga modal contabilidad sin cerrar
        verContabilidad({ closest: () => ({ dataset: { id: quitarProyectoId } }) });
    });

});


// ===================================================================
// ACTIVAR BOTONES
// ===================================================================
document.querySelectorAll('.btnContabilidad').forEach(btn => {
    btn.addEventListener('click', () => verContabilidad(btn));
});

// ============================================================
// CALCULAR UTILIDAD Y EGRESOS SEG√öN FILTRO DE FECHAS
// ============================================================

function actualizarCards() {

    const filas = document.querySelectorAll("#tablaProyectos tbody tr");

    let utilidadTotal = 0;
    let egresosTotal = 0;

    filas.forEach(row => {

        if (row.style.display === "none") return; // Solo visibles

        const utilidad = parseInt(row.dataset.utilidad || 0);
        const egresos  = parseInt(row.dataset.egresos || 0);

        utilidadTotal += utilidad;
        egresosTotal  += egresos;
    });

    document.getElementById("card-utilidad").textContent = 
        "$" + utilidadTotal.toLocaleString();

    document.getElementById("card-egresos").textContent = 
        "$" + egresosTotal.toLocaleString();
}


// Activar cada vez que se filtre
document.getElementById("btnFiltrarFecha").addEventListener("click", () => {
    setTimeout(actualizarCards, 100);
});

document.getElementById("btnLimpiarFiltro").addEventListener("click", () => {
    setTimeout(actualizarCards, 100);
});

// Actualizar al cargar
actualizarCards();


</script>

</body>
</html>
